<!doctype html>
<html lang="bg" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Polyglot Switch — BG ↔ EN/ES/PT/DE/TL</title>
  <meta name="theme-color" content="#0d6efd">
  <link rel="apple-touch-icon" href="#" id="appleIcon"/>
  <link rel="manifest" href="#" id="manifestLink"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{--tap:14px}
    body{min-height:100vh;background:linear-gradient(180deg,var(--bs-body-bg),rgba(0,0,0,0.02))}
    .card textarea{min-height:140px;resize:vertical}
    .kbd{padding:.1rem .35rem;border:1px solid var(--bs-border-color);border-radius:.25rem;background:var(--bs-tertiary-bg);font-size:.8rem}
    .fade-enter{animation:fadeIn .18s ease-out}
    .btm-bar{position:sticky;bottom:0;left:0;right:0;z-index:1030}
    .btm-bar .btn{min-height:44px}
    @keyframes fadeIn{from{opacity:.3;transform:translateY(2px)}to{opacity:1;transform:none}}
    @media (max-width: 991.98px){ /* mobile: показвай само BG + активния език */
      .lang-card{display:none}
      .lang-card.active{display:block}
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg border-bottom sticky-top bg-body">
  <div class="container-lg">
    <a class="navbar-brand fw-semibold" href="#">Polyglot <span class="text-primary">Switch</span></a>
    <div class="d-flex align-items-center gap-2 ms-auto">
      <div class="d-none d-lg-flex align-items-center gap-2">
        <label class="small text-secondary mb-0">Език:</label>
        <select id="langSelect" class="form-select form-select-sm" style="width:110px">
          <option value="en">EN</option>
          <option value="es">ES</option>
          <option value="pt">PT</option>
          <option value="de">DE</option>
          <option value="tl">TL</option>
        </select>
      </div>
      <span id="pairBadge" class="badge text-bg-secondary">BG ↔ EN</span>
      <button id="btnTheme" class="btn btn-sm btn-outline-secondary" type="button" title="Смени тема">Тема</button>
      <button class="btn btn-sm btn-outline-success" id="btnInstall" type="button" hidden>Инсталирай</button>
      <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#settingsModal">Настройки</button>
    </div>
  </div>
</nav>

<main class="container-lg py-3">
  <div class="row g-3">
    <!-- Bulgarian panel (pivot) -->
    <div class="col-12 col-lg-6">
      <div class="card h-100 shadow-sm fade-enter">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div>
            <div class="fw-semibold">Български</div>
            <small class="text-secondary">Пишеш тук → превежда към <span id="toLang">EN</span></small>
          </div>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" id="bgPaste">Paste</button>
            <button class="btn btn-sm btn-outline-secondary" id="bgCopy">Copy</button>
            <button class="btn btn-sm btn-outline-secondary" id="bgClear">Clear</button>
            <button class="btn btn-sm btn-success" id="bgTranslate">Преведи</button>
          </div>
        </div>
        <div class="card-body">
          <textarea id="taBG" class="form-control" placeholder="Пиши или постави български… (Ctrl/⌘+Enter превежда)"></textarea>
          <div class="d-flex align-items-center gap-2 mt-2">
            <button class="btn btn-sm btn-outline-primary" id="btnDetect">Auto detect ↔</button>
            <small class="text-secondary">Ще засече езика на въведения текст и ще преведе към BG.</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Right column: one card per foreign language (mobile показва само активния) -->
    <div class="col-12 col-lg-6">
      <div class="row g-3">
        
        <div class="col-12 col-md-6">
          <div class="card h-100 shadow-sm lang-card active" data-lang="en">
            <div class="card-header d-flex align-items-center justify-content-between">
              <div>
                <div class="fw-semibold">English</div>
                <small class="text-secondary">Този панел задава активния език</small>
              </div>
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary" data-action="copy">Copy</button>
                <button class="btn btn-sm btn-outline-secondary" data-action="clear">Clear</button>
                <button class="btn btn-sm btn-primary" data-action="translate">Translate</button>
              </div>
            </div>
            <div class="card-body">
              <textarea class="form-control" placeholder="Type English…"></textarea>
              <div class="d-flex align-items-center justify-content-between mt-2">
                <small class="text-secondary">ISO: <code>en</code></small>
                <button class="btn btn-sm btn-outline-dark" data-action="make-active">Активирай ↔</button>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-6">
          <div class="card h-100 shadow-sm lang-card" data-lang="es">
            <div class="card-header d-flex align-items-center justify-content-between">
              <div>
                <div class="fw-semibold">Español</div>
                <small class="text-secondary">Este panel define el idioma activo</small>
              </div>
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary" data-action="copy">Copiar</button>
                <button class="btn btn-sm btn-outline-secondary" data-action="clear">Limpiar</button>
                <button class="btn btn-sm btn-primary" data-action="translate">Traducir</button>
              </div>
            </div>
            <div class="card-body">
              <textarea class="form-control" placeholder="Escribe en español…"></textarea>
              <div class="d-flex align-items-center justify-content-between mt-2">
                <small class="text-secondary">ISO: <code>es</code></small>
                <button class="btn btn-sm btn-outline-dark" data-action="make-active">Activar ↔</button>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-6">
          <div class="card h-100 shadow-sm lang-card" data-lang="pt">
            <div class="card-header d-flex align-items-center justify-content-between">
              <div>
                <div class="fw-semibold">Português (BR)</div>
                <small class="text-secondary">Este painel define o idioma ativo</small>
              </div>
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary" data-action="copy">Copiar</button>
                <button class="btn btn-sm btn-outline-secondary" data-action="clear">Limpar</button>
                <button class="btn btn-sm btn-primary" data-action="translate">Traduzir</button>
              </div>
            </div>
            <div class="card-body">
              <textarea class="form-control" placeholder="Digite em português…"></textarea>
              <div class="d-flex align-items-center justify-content-between mt-2">
                <small class="text-secondary">ISO: <code>pt</code></small>
                <button class="btn btn-sm btn-outline-dark" data-action="make-active">Ativar ↔</button>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-6">
          <div class="card h-100 shadow-sm lang-card" data-lang="de">
            <div class="card-header d-flex align-items-center justify-content-between">
              <div>
                <div class="fw-semibold">Deutsch</div>
                <small class="text-secondary">Dieses Panel setzt die aktive Sprache</small>
              </div>
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary" data-action="copy">Kopieren</button>
                <button class="btn btn-sm btn-outline-secondary" data-action="clear">Löschen</button>
                <button class="btn btn-sm btn-primary" data-action="translate">Übersetzen</button>
              </div>
            </div>
            <div class="card-body">
              <textarea class="form-control" placeholder="Deutsch schreiben…"></textarea>
              <div class="d-flex align-items-center justify-content-between mt-2">
                <small class="text-secondary">ISO: <code>de</code></small>
                <button class="btn btn-sm btn-outline-dark" data-action="make-active">Aktivieren ↔</button>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-6">
          <div class="card h-100 shadow-sm lang-card" data-lang="tl">
            <div class="card-header d-flex align-items-center justify-content-between">
              <div>
                <div class="fw-semibold">Filipino (Tagalog)</div>
                <small class="text-secondary">Ang panel na ito ang nagtatakda ng aktibong wika</small>
              </div>
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary" data-action="copy">Kopyahin</button>
                <button class="btn btn-sm btn-outline-secondary" data-action="clear">I‑clear</button>
                <button class="btn btn-sm btn-primary" data-action="translate">Isalin</button>
              </div>
            </div>
            <div class="card-body">
              <textarea class="form-control" placeholder="Magsulat sa Tagalog…"></textarea>
              <div class="d-flex align-items-center justify-content-between mt-2">
                <small class="text-secondary">ISO: <code>tl</code></small>
                <button class="btn btn-sm btn-outline-dark" data-action="make-active">I‑activate ↔</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="text-secondary small mt-3">
    Съвет: <span class="kbd">Ctrl/⌘ + Enter</span> превежда от активната графа. Активният език се сменя с превод от неговия панел, с „Активирай ↔“, или от падащото меню горе.
  </div>
</main>

<!-- Bottom action bar (mobile) -->
<div class="btm-bar bg-body border-top py-2">
  <div class="container-lg d-flex gap-2">
    <button class="btn btn-outline-primary flex-grow-1" id="quickPaste">Постави</button>
    <button class="btn btn-outline-secondary" id="quickSwap" title="Смени активния език">↔</button>
    <button class="btn btn-primary flex-grow-1" id="quickTranslate">Преведи</button>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Настройки</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">API Endpoint</label>
          <input id="endpoint" type="url" class="form-control" placeholder="http://127.0.0.1:5050">
          <div class="form-text">По подразбиране: локалният ти прокси. Ако падне, фронтендът има директен fallback.</div>
        </div>
        <div id="diag" class="small text-secondary"></div>
      </div>
      <div class="modal-footer">
        <button id="btnTest" class="btn btn-outline-secondary">Тест /languages</button>
        <button id="btnSave" class="btn btn-primary" data-bs-dismiss="modal">Запази</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // ===== App state =====
  const LS = 'polyglot.switch.v2';
  const DEFAULT_ENDPOINT = 'http://127.0.0.1:5050';
  let state = { endpoint: DEFAULT_ENDPOINT, activeLang: 'en', theme: 'light' };

  function loadState(){ try{ Object.assign(state, JSON.parse(localStorage.getItem(LS)||'{}')); }catch{} document.documentElement.setAttribute('data-bs-theme', state.theme||'light'); }
  function saveState(){ localStorage.setItem(LS, JSON.stringify(state)); }
  const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
  const $ = (s, r=document)=> r.querySelector(s);

  function updatePairBadge(){
    $('#pairBadge').textContent = `BG ↔ ${state.activeLang.toUpperCase()}`;
    $('#toLang').textContent = state.activeLang.toUpperCase();
    $('#langSelect').value = state.activeLang;
    $$('.lang-card').forEach(c=> c.classList.toggle('active', c.dataset.lang===state.activeLang));
  }

  async function api(path, opts){ const url=(state.endpoint||DEFAULT_ENDPOINT).replace(/\/$/,'')+path; const r=await fetch(url,opts); if(!r.ok) throw new Error('HTTP '+r.status+' '+path); return r.json(); }
  const mm = c => c.toLowerCase()==='pt' ? 'pt-BR' : c.toLowerCase();
  async function myMemory(q,src,tgt){ const s=mm(src), t=mm(tgt); const r=await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(q)}&langpair=${encodeURIComponent(s)}|${encodeURIComponent(t)}`); if(!r.ok) throw new Error('MyMemory '+r.status); const d=await r.json(); return d?.responseData?.translatedText||''; }
  async function translateSmart(q,src,tgt){ try{ const d=await api('/translate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({q,source:src,target:tgt,format:'text'})}); if(d?.translatedText) return d.translatedText; throw new Error('bad'); } catch(e){ return await myMemory(q,src,tgt); } }
  async function detectViaProxy(q){ try{ const d=await api('/detect',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({q})}); if(Array.isArray(d)&&d[0]?.language) return d[0].language; }catch{} return 'auto'; }

  function wire(){
    // Theme
    $('#btnTheme').addEventListener('click', ()=>{ state.theme = state.theme==='dark'?'light':'dark'; document.documentElement.setAttribute('data-bs-theme', state.theme); saveState(); });
    // Lang select (desktop)
    $('#langSelect').addEventListener('change', e=>{ state.activeLang=e.target.value; saveState(); updatePairBadge(); });

    // Settings
    const endpointInput = $('#settingsModal #endpoint'); const diag = $('#settingsModal #diag');
    $('#settingsModal').addEventListener('show.bs.modal', ()=>{ endpointInput.value = state.endpoint; diag.textContent=''; });
    $('#btnSave').addEventListener('click', ()=>{ state.endpoint = endpointInput.value.trim()||DEFAULT_ENDPOINT; saveState(); });
    $('#btnTest').addEventListener('click', async()=>{ diag.textContent='Тествам…'; try{ const data=await api('/languages'); diag.textContent='OK: '+(Array.isArray(data)?data.map(x=>x.code).join(', '):JSON.stringify(data)); }catch(e){ diag.textContent='Грешка: '+e.message; }});

    // BG
    $('#bgPaste').addEventListener('click', async()=>{ try{ $('#taBG').value = await navigator.clipboard.readText(); }catch{} });
    $('#bgCopy').addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText($('#taBG').value); }catch{} });
    $('#bgClear').addEventListener('click', ()=> $('#taBG').value='');
    $('#bgTranslate').addEventListener('click', ()=> translateFromBG());
    $('#taBG').addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); translateFromBG(); }});

    // Foreign panels
    $$('.card[data-lang]').forEach(card=>{
      const lang = card.dataset.lang; const ta = $('textarea', card);
      $('[data-action="make-active"]', card).addEventListener('click', ()=>{ state.activeLang=lang; saveState(); updatePairBadge(); });
      $('[data-action="translate"]', card).addEventListener('click', ()=> translateFromForeign(lang, ta.value));
      ta.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); translateFromForeign(lang, ta.value); }});
      $('[data-action="copy"]', card).addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText(ta.value||''); }catch{} });
      $('[data-action="clear"]', card).addEventListener('click', ()=> ta.value='');
    });

    // Bottom bar quick actions
    $('#quickPaste').addEventListener('click', async()=>{ try{ $('#taBG').value = await navigator.clipboard.readText(); }catch{} });
    $('#quickSwap').addEventListener('click', ()=>{ const order=['en','es','pt','de','tl']; const i=order.indexOf(state.activeLang); state.activeLang=order[(i+1)%order.length]; saveState(); updatePairBadge(); });
    $('#quickTranslate').addEventListener('click', ()=> translateFromBG());
  }

  async function translateFromBG(){ const q=$('#taBG').value.trim(); if(!q) return; const tgt=state.activeLang||'en'; const out=await translateSmart(q,'bg',tgt); const targetTa=document.querySelector(`.card[data-lang="${tgt}"] textarea`); if(targetTa) targetTa.value=out; updatePairBadge(); }
  async function translateFromForeign(lang,text){ const q=(text||'').trim(); if(!q) return; state.activeLang=lang; saveState(); updatePairBadge(); const out=await translateSmart(q,lang,'bg'); $('#taBG').value=out; }

  // Boot
  loadState();
  updatePairBadge();
  wire();

  // PWA single-file setup (manifest + SW + icons)
  (function(){ try{
    const sizes=[192,512]; const icons=sizes.map(sz=>{ const c=document.createElement('canvas'); c.width=c.height=sz; const g=c.getContext('2d'); g.fillStyle='#0d6efd'; g.beginPath(); g.arc(sz/2,sz/2,sz/2-8,0,Math.PI*2); g.fill(); g.fillStyle='#fff'; g.font=(sz*0.42)+'px system-ui'; g.textAlign='center'; g.textBaseline='middle'; g.fillText('PS', sz/2, sz/2+2); return {src:c.toDataURL('image/png'), sizes:sz+'x'+sz, type:'image/png'}; });
    const manifest={ name:'Polyglot Switch', short_name:'Polyglot', start_url:'./', display:'standalone', background_color:'#ffffff', theme_color:'#0d6efd', icons};
    const mblob=new Blob([JSON.stringify(manifest)],{type:'application/json'}); const murl=URL.createObjectURL(mblob); document.getElementById('manifestLink').href=murl; document.getElementById('appleIcon').href=icons[0].src;
    if('serviceWorker' in navigator){ const sw=`self.addEventListener('install',e=>{self.skipWaiting(); e.waitUntil(caches.open('polyglot-v1').then(c=>c.addAll(['./'])))}); self.addEventListener('activate',e=>self.clients.claim()); self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match(e.request).then(r=>r||caches.match('./'))))});`; const sblob=new Blob([sw],{type:'text/javascript'}); const surl=URL.createObjectURL(sblob); navigator.serviceWorker.register(surl,{scope:'./'}).catch(()=>{}); }
    let promptEvt; window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); promptEvt=e; const b=document.getElementById('btnInstall'); b.hidden=false; b.onclick=()=>{ promptEvt.prompt(); b.hidden=true; }; });
  }catch(_){}})();
</script>
</body>
</html>
