<!doctype html>
<html lang="bg" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Polyglot Switch — Any ↔ Any (BG/EN/ES/PT/DE/TL/ID)</title>
  <meta name="theme-color" content="#0d6efd">
  <link rel="apple-touch-icon" href="icon-192.png"/>
  <link rel="manifest" href="manifest.json"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{--tap:14px}
    body{min-height:100vh;background:linear-gradient(180deg,var(--bs-body-bg),rgba(0,0,0,0.02))}
    .card textarea{min-height:140px;resize:vertical}
    .kbd{padding:.1rem .35rem;border:1px solid var(--bs-border-color);border-radius:.25rem;background:var(--bs-tertiary-bg);font-size:.8rem}
    .fade-enter{animation:fadeIn .18s ease-out}
    @keyframes fadeIn{from{opacity:.3;transform:translateY(2px)}to{opacity:1;transform:none}}
    /* mobile: показвай само активния панел долу */
    @media (max-width: 991.98px){
      .lang-col{display:none;}
      .lang-col.active{display:block;}
      .lang-card{display:block;width:100%}
    }
    .btm-bar{position:sticky;bottom:0;left:0;right:0;z-index:1030}
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg border-bottom sticky-top bg-body">
  <div class="container-lg">
    <a class="navbar-brand fw-semibold" href="#">Polyglot <span class="text-primary">Switch</span></a>

    <div class="d-flex align-items-center gap-2 ms-auto">
      <div class="d-none d-lg-flex align-items-center gap-2">
        <label id="lblMyLang" class="small text-secondary mb-0">Моят език:</label>
        <select id="userLangSelect" class="form-select form-select-sm" style="width:120px">
          <option value="bg">BG</option><option value="en">EN</option><option value="es">ES</option>
          <option value="pt">PT</option><option value="de">DE</option><option value="tl">TL</option><option value="id">ID</option>
        </select>
        <label id="lblPartner" class="small text-secondary mb-0">Партньор:</label>
        <select id="langSelect" class="form-select form-select-sm" style="width:110px">
          <option value="en">EN</option><option value="es">ES</option><option value="pt">PT</option>
          <option value="de">DE</option><option value="tl">TL</option><option value="id">ID</option>
        </select>
      </div>
      <span id="pairBadge" class="badge text-bg-secondary">BG ↔ EN</span>
      <button id="btnTheme" class="btn btn-sm btn-outline-secondary" type="button" title="Смени тема">Тема</button>
      <button class="btn btn-sm btn-outline-success" id="btnInstall" type="button" hidden>Инсталирай</button>
      <button class="btn btn-sm btn-secondary" id="btnReadme" type="button" data-bs-toggle="modal" data-bs-target="#readmeModal">README</button>
      <button class="btn btn-sm btn-primary" id="btnSettings" data-bs-toggle="modal" data-bs-target="#settingsModal">Настройки</button>
    </div>
  </div>
</nav>

<main class="container-lg py-3">
  <!-- TOP: input on full width -->
  <div class="row g-3">
    <div class="col-12">
      <div class="card h-100 shadow-sm fade-enter">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div>
            <div class="fw-semibold" id="userLangTitle">Моят език</div>
            <small class="text-secondary"><span id="hintPrefix">Пишеш тук → превежда към</span> <span id="toLang">EN</span></small>
          </div>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" id="userPaste">Постави</button>
            <button class="btn btn-sm btn-outline-secondary" id="userCopy">Копирай</button>
            <button class="btn btn-sm btn-outline-secondary" id="userClear">Изчисти</button>
            <button class="btn btn-sm btn-success" id="userTranslate">Преведи</button>
          </div>
        </div>
        <div class="card-body">
          <textarea id="taUSER" class="form-control" placeholder="Пиши на избрания си език… (Ctrl/⌘+Enter превежда)"></textarea>
          <div class="d-flex align-items-center gap-2 mt-2">
            <button class="btn btn-sm btn-outline-primary" id="btnDetect">Auto detect ↔</button>
            <small class="text-secondary" id="detectHint">Засича езика и превежда към „Моят език“; актуализира активния.</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOTTOM: language panels grid -->
  <div class="row g-3 mt-1">
    <div class="col-12 col-md-6 col-lg-4 lang-col active">
      <div class="card h-100 shadow-sm lang-card active" data-lang="en">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div><div class="fw-semibold">English</div><small class="text-secondary">This panel sets the active language</small></div>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" data-action="copy">Copy</button>
            <button class="btn btn-sm btn-outline-secondary" data-action="clear">Clear</button>
            <button class="btn btn-sm btn-primary" data-action="translate">Translate</button>
          </div>
        </div>
        <div class="card-body">
          <textarea class="form-control" placeholder="Type English…"></textarea>
          <div class="d-flex align-items-center justify-content-between mt-2">
            <small class="text-secondary">ISO: <code>en</code></small>
            <button class="btn btn-sm btn-outline-dark" data-action="make-active">Активирай ↔</button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-4 lang-col">
      <div class="card h-100 shadow-sm lang-card" data-lang="es">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div><div class="fw-semibold">Español</div><small class="text-secondary">Este panel define el idioma activo</small></div>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" data-action="copy">Copiar</button>
            <button class="btn btn-sm btn-outline-secondary" data-action="clear">Limpiar</button>
            <button class="btn btn-sm btn-primary" data-action="translate">Traducir</button>
          </div>
        </div>
        <div class="card-body">
          <textarea class="form-control" placeholder="Escribe en español…"></textarea>
          <div class="d-flex align-items-center justify-content-between mt-2">
            <small class="text-secondary">ISO: <code>es</code></small>
            <button class="btn btn-sm btn-outline-dark" data-action="make-active">Activar ↔</button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-4 lang-col">
      <div class="card h-100 shadow-sm lang-card" data-lang="pt">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div><div class="fw-semibold">Português (BR)</div><small class="text-secondary">Este painel define o idioma ativo</small></div>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" data-action="copy">Copiar</button>
            <button class="btn btn-sm btn-outline-secondary" data-action="clear">Limpar</button>
            <button class="btn btn-sm btn-primary" data-action="translate">Traduzir</button>
          </div>
        </div>
        <div class="card-body">
          <textarea class="form-control" placeholder="Digite em português…"></textarea>
          <div class="d-flex align-items-center justify-content-between mt-2">
            <small class="text-secondary">ISO: <code>pt</code></small>
            <button class="btn btn-sm btn-outline-dark" data-action="make-active">Ativar ↔</button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-4 lang-col">
      <div class="card h-100 shadow-sm lang-card" data-lang="de">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div><div class="fw-semibold">Deutsch</div><small class="text-secondary">Dieses Panel setzt die aktive Sprache</small></div>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" data-action="copy">Kopieren</button>
            <button class="btn btn-sm btn-outline-secondary" data-action="clear">Löschen</button>
            <button class="btn btn-sm btn-primary" data-action="translate">Übersetzen</button>
          </div>
        </div>
        <div class="card-body">
          <textarea class="form-control" placeholder="Deutsch schreiben…"></textarea>
          <div class="d-flex align-items-center justify-content-between mt-2">
            <small class="text-secondary">ISO: <code>de</code></small>
            <button class="btn btn-sm btn-outline-dark" data-action="make-active">Aktivieren ↔</button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-4 lang-col">
      <div class="card h-100 shadow-sm lang-card" data-lang="tl">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div><div class="fw-semibold">Filipino (Tagalog)</div><small class="text-secondary">Ang panel na ito ang nagtatakda ng aktibong wika</small></div>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" data-action="copy">Kopyahin</button>
            <button class="btn btn-sm btn-outline-secondary" data-action="clear">I-clear</button>
            <button class="btn btn-sm btn-primary" data-action="translate">Isalin</button>
          </div>
        </div>
        <div class="card-body">
          <textarea class="form-control" placeholder="Magsulat sa Tagalog…"></textarea>
          <div class="d-flex align-items-center justify-content-between mt-2">
            <small class="text-secondary">ISO: <code>tl</code></small>
            <button class="btn btn-sm btn-outline-dark" data-action="make-active">I-activate ↔</button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6 col-lg-4 lang-col">
      <div class="card h-100 shadow-sm lang-card" data-lang="id">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div><div class="fw-semibold">Bahasa Indonesia</div><small class="text-secondary">Panel ini menentukan bahasa aktif</small></div>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" data-action="copy">Salin</button>
            <button class="btn btn-sm btn-outline-secondary" data-action="clear">Bersihkan</button>
            <button class="btn btn-sm btn-primary" data-action="translate">Terjemahkan</button>
          </div>
        </div>
        <div class="card-body">
          <textarea class="form-control" placeholder="Ketik bahasa Indonesia…"></textarea>
          <div class="d-flex align-items-center justify-content-between mt-2">
            <small class="text-secondary">ISO: <code>id</code></small>
            <button class="btn btn-sm btn-outline-dark" data-action="make-active">Aktifkan ↔</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <p class="text-secondary small mt-3">
    <span class="kbd">Ctrl/⌘ + Enter</span> превежда текущото поле. На мобилно — превключвай активния език с бутона в картата.
  </p>
</main>

<!-- Bottom bar: only swap (↔) -->
<div class="btm-bar bg-body border-top py-2">
  <div class="container-lg d-flex justify-content-center">
    <button class="btn btn-outline-secondary" id="quickSwap" title="Смени активния език">↔</button>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">Настройки</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body">
      <div class="mb-3">
        <label class="form-label">API Endpoint</label>
        <input id="endpoint" type="url" class="form-control" placeholder="http://127.0.0.1:5050">
        <div class="form-text">На GitHub Pages не се ползва локален proxy. Има HTTPS fallback.</div>
      </div>
      <div id="diag" class="small text-secondary"></div>
    </div>
    <div class="modal-footer">
      <button id="btnTest" class="btn btn-outline-secondary">Тест /languages</button>
      <button id="btnSave" class="btn btn-primary" data-bs-dismiss="modal">Запази</button>
    </div>
  </div></div>
</div>

<!-- README Modal -->
<div class="modal fade" id="readmeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="readmeTitle">Как да използваш приложението</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body" id="readmeBody"></div>
    <div class="modal-footer">
      <button class="btn btn-primary" data-bs-dismiss="modal" id="readmeClose">Разбрах</button>
    </div>
  </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // ===== State & helpers =====
  const LS = 'polyglot.switch.v8';
  const IS_LOCAL = ['localhost','127.0.0.1'].includes(location.hostname);
  const DEFAULT_ENDPOINT = IS_LOCAL ? 'http://127.0.0.1:5050' : '';
  const LANG_NAMES = { bg:'Български', en:'English', es:'Español', pt:'Português (BR)', de:'Deutsch', tl:'Filipino (Tagalog)', id:'Bahasa Indonesia' };
  let state = { endpoint: DEFAULT_ENDPOINT, userLang: 'bg', activeLang: 'en', theme: 'light' };

  const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
  const $  = (s, r=document)=> r.querySelector(s);
  function loadState(){ try{ Object.assign(state, JSON.parse(localStorage.getItem(LS)||'{}')); }catch{} if(!IS_LOCAL) state.endpoint=''; document.documentElement.setAttribute('data-bs-theme', state.theme||'light'); }
  function saveState(){ localStorage.setItem(LS, JSON.stringify(state)); }

  // ===== API & translation =====
  async function api(path, opts){
    if(!state.endpoint) throw new Error('no-endpoint'); // на Pages пада на HTTPS fallback
    const url=(state.endpoint||DEFAULT_ENDPOINT).replace(/\/$/,'')+path;
    const r=await fetch(url,opts); if(!r.ok) throw new Error('HTTP '+r.status+' '+path); return r.json();
  }
  const mm = c => c.toLowerCase()==='pt' ? 'pt-BR' : c.toLowerCase();
  async function myMemory(q,src,tgt){
    const s=mm(src), t=mm(tgt);
    const r=await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(q)}&langpair=${encodeURIComponent(s)}|${encodeURIComponent(t)}`);
    if(!r.ok) throw new Error('MyMemory '+r.status);
    const d=await r.json(); return d?.responseData?.translatedText||'';
  }
  async function translateSmart(q,src,tgt){
    try{
      const d=await api('/translate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({q,source:src,target:tgt,format:'text'})});
      if(d?.translatedText) return d.translatedText; throw new Error('bad');
    }catch(e){ return await myMemory(q,src,tgt); }
  }
  async function detectViaProxy(q){
    try{ const d=await api('/detect',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({q})}); if(Array.isArray(d)&&d[0]?.language) return d[0].language; }catch{}
    return 'auto';
  }

  // ===== UI update =====
  function updatePairBadge(){
    $('#pairBadge').textContent = `${state.userLang.toUpperCase()} ↔ ${state.activeLang.toUpperCase()}`;
    $('#toLang').textContent = state.activeLang.toUpperCase();
    $('#langSelect').value = state.activeLang;
    $('#userLangSelect').value = state.userLang;
    $('#userLangTitle').textContent = LANG_NAMES[state.userLang] || 'Моят език';

    $$('.lang-card').forEach(c=>{
      const on = c.dataset.lang === state.activeLang;
      c.classList.toggle('active', on);
      c.closest('.lang-col')?.classList.toggle('active', on);
    });
  }

  // ===== I18N dictionary =====
  const I18N = {
    bg:{nav_my:'Моят език:',nav_partner:'Партньор:',theme:'Тема',install:'Инсталирай',settings:'Настройки',readme:'README',
        user_title:'Моят език',hint_prefix:'Пишеш тук → превежда към',
        paste:'Постави',copy:'Копирай',clear:'Изчисти',translate:'Преведи',
        autodetect:'Auto detect ↔',detect_hint:'Засича езика и превежда към „Моят език“; актуализира активния.',
        readme_title:'Как да използваш приложението',readme_ok:'Разбрах',
        readme_html:`<ol class="mb-2">
          <li><b>Моят език</b> (UI+pivot) и <b>Партньор</b> (цел) са горе вдясно.</li>
          <li>Пиши <b>горе</b> → <b>Преведи</b> или <b>Ctrl/⌘+Enter</b> изпраща към <b>Партньор</b>.</li>
          <li>Пиши в десен панел → <b>Translate</b> връща към <b>Моят език</b> и го прави активен.</li>
          <li>Долната лента има само <b>↔</b> за бърза смяна.</li>
        </ol>`},
    en:{nav_my:'My language:',nav_partner:'Partner:',theme:'Theme',install:'Install',settings:'Settings',readme:'README',
        user_title:'My language',hint_prefix:'Type here → translates to',
        paste:'Paste',copy:'Copy',clear:'Clear',translate:'Translate',
        autodetect:'Auto detect ↔',detect_hint:'Detects and translates to “My language”; updates active.',
        readme_title:'How to use',readme_ok:'Got it',
        readme_html:`<ol class="mb-2">
          <li><b>My language</b> (UI+pivot) and <b>Partner</b> (target) are top-right.</li>
          <li>Type above → <b>Translate</b> or <b>Ctrl/⌘+Enter</b> sends to <b>Partner</b>.</li>
          <li>Right panel → <b>Translate</b> sends back to <b>My language</b> and makes it active.</li>
          <li>The bottom bar keeps only <b>↔</b> for quick switch.</li>
        </ol>`},
    es:{nav_my:'Mi idioma:',nav_partner:'Pareja:',theme:'Tema',install:'Instalar',settings:'Ajustes',readme:'README',
        user_title:'Mi idioma',hint_prefix:'Escribe aquí → traduce a',
        paste:'Pegar',copy:'Copiar',clear:'Limpiar',translate:'Traducir',
        autodetect:'Auto detectar ↔',detect_hint:'Detecta y traduce a “Mi idioma”; actualiza el activo.',
        readme_title:'Cómo usar',readme_ok:'Entendido',
        readme_html:`<ol class="mb-2"><li><b>Mi idioma</b> (UI+pivote) y <b>Pareja</b> (destino) arriba a la derecha.</li><li>Arriba → <b>Traducir</b> o <b>Ctrl/⌘+Enter</b> a <b>Pareja</b>.</li><li>Panel derecho → a <b>Mi idioma</b>.</li><li>Abajo queda solo <b>↔</b>.</li></ol>`},
    pt:{nav_my:'Meu idioma:',nav_partner:'Parceiro:',theme:'Tema',install:'Instalar',settings:'Configurações',readme:'README',
        user_title:'Meu idioma',hint_prefix:'Digite aqui → traduz para',
        paste:'Colar',copy:'Copiar',clear:'Limpar',translate:'Traduzir',
        autodetect:'Auto detectar ↔',detect_hint:'Detecta e traduz para “Meu idioma”; atualiza o ativo.',
        readme_title:'Como usar',readme_ok:'Entendi',
        readme_html:`<ol class="mb-2"><li><b>Meu idioma</b> (UI+pivô) e <b>Parceiro</b> (alvo) no canto superior direito.</li><li>Acima → <b>Traduzir</b> ou <b>Ctrl/⌘+Enter</b> para <b>Parceiro</b>.</li><li>Painel direito → de volta ao <b>Meu idioma</b>.</li><li>A barra inferior fica só com <b>↔</b>.</li></ol>`},
    de:{nav_my:'Meine Sprache:',nav_partner:'Partner:',theme:'Thema',install:'Installieren',settings:'Einstellungen',readme:'README',
        user_title:'Meine Sprache',hint_prefix:'Hier schreiben → übersetzt nach',
        paste:'Einfügen',copy:'Kopieren',clear:'Leeren',translate:'Übersetzen',
        autodetect:'Auto erkennen ↔',detect_hint:'Erkennt und übersetzt zu „Meine Sprache“; aktualisiert aktiv.',
        readme_title:'Anleitung',readme_ok:'Alles klar',
        readme_html:`<ol class="mb-2"><li><b>Meine Sprache</b> (UI+Drehpunkt) und <b>Partner</b> (Ziel) oben rechts.</li><li>Oben → <b>Übersetzen</b> oder <b>Ctrl/⌘+Enter</b> zu <b>Partner</b>.</li><li>Rechts → zurück zu <b>Meine Sprache</b>.</li><li>Unten bleibt nur <b>↔</b>.</li></ol>`},
    tl:{nav_my:'Aking wika:',nav_partner:'Katuwang:',theme:'Tema',install:'I-install',settings:'Mga setting',readme:'README',
        user_title:'Aking wika',hint_prefix:'Dito magsulat → isasalin sa',
        paste:'I-paste',copy:'Kopyahin',clear:'I-clear',translate:'Isalin',
        autodetect:'Auto detect ↔',detect_hint:'Tinutukoy at isinasalin sa “Aking wika”; ina-update ang aktibo.',
        readme_title:'Paano gamitin',readme_ok:'Sige',
        readme_html:`<ol class="mb-2"><li><b>Aking wika</b> (UI+pivot) at <b>Katuwang</b> (target) sa itaas na kanan.</li><li>Sa itaas → <b>Isalin</b> o <b>Ctrl/⌘+Enter</b>.</li><li>Kanang panel → balik sa <b>Aking wika</b>.</li><li>Sa ibaba nananatili lang ang <b>↔</b>.</li></ol>`},
    id:{nav_my:'Bahasa saya:',nav_partner:'Pasangan:',theme:'Tema',install:'Pasang',settings:'Pengaturan',readme:'README',
        user_title:'Bahasa saya',hint_prefix:'Ketik di sini → terjemahkan ke',
        paste:'Tempel',copy:'Salin',clear:'Bersihkan',translate:'Terjemahkan',
        autodetect:'Deteksi otomatis ↔',detect_hint:'Mendeteksi dan menerjemahkan ke “Bahasa saya”; memperbarui aktif.',
        readme_title:'Cara pakai',readme_ok:'Mengerti',
        readme_html:`<ol class="mb-2"><li><b>Bahasa saya</b> (UI+pivot) dan <b>Pasangan</b> (target) di kanan atas.</li><li>Di atas → <b>Terjemahkan</b> atau <b>Ctrl/⌘+Enter</b> ke <b>Pasangan</b>.</li><li>Panel kanan → kembali ke <b>Bahasa saya</b>.</li><li>Bar bawah hanya menyisakan <b>↔</b>.</li></ol>`}
  };

  function applyI18N(){
    const tr = I18N[state.userLang] || I18N.en;
    // Navbar
    $('#lblMyLang').textContent = tr.nav_my;
    $('#lblPartner').textContent = tr.nav_partner;
    $('#btnTheme').textContent = tr.theme;
    $('#btnInstall').textContent = tr.install;
    $('#btnSettings').textContent = tr.settings;
    $('#btnReadme').textContent = tr.readme;
    // Top panel
    $('#userLangTitle').textContent = LANG_NAMES[state.userLang] || tr.user_title;
    $('#hintPrefix').textContent = tr.hint_prefix;
    $('#userPaste').textContent  = tr.paste;
    $('#userCopy').textContent   = tr.copy;
    $('#userClear').textContent  = tr.clear;
    $('#userTranslate').textContent = tr.translate;
    $('#btnDetect').textContent  = tr.autodetect;
    $('#detectHint').textContent = tr.detect_hint;
    // README
    $('#readmeTitle').textContent = tr.readme_title;
    $('#readmeBody').innerHTML   = tr.readme_html;
    $('#readmeClose').textContent= tr.readme_ok;
  }

  // ===== Actions =====
  async function translateFromUser(){
    const q = $('#taUSER').value.trim(); if(!q) return;
    const out = await translateSmart(q, state.userLang, state.activeLang);
    const targetTa = document.querySelector(`.card[data-lang="${state.activeLang}"] textarea`);
    if(targetTa) targetTa.value = out;
    updatePairBadge();
  }
  async function translateFromForeign(lang, text){
    const q = (text||'').trim(); if(!q) return;
    state.activeLang = lang; saveState(); updatePairBadge();
    const out = await translateSmart(q, lang, state.userLang);
    $('#taUSER').value = out;
  }

  // ===== Wiring =====
  function wire(){
    // Theme
    $('#btnTheme').addEventListener('click', ()=>{ state.theme = state.theme==='dark'?'light':'dark'; document.documentElement.setAttribute('data-bs-theme', state.theme); saveState(); });

    // Selects
    $('#langSelect').addEventListener('change', e=>{ state.activeLang=e.target.value; saveState(); updatePairBadge(); });
    $('#userLangSelect').addEventListener('change', e=>{ state.userLang=e.target.value; saveState(); applyI18N(); updatePairBadge(); });

    // Settings
    const endpointInput = $('#endpoint'); const diag = $('#diag');
    $('#settingsModal').addEventListener('show.bs.modal', ()=>{ endpointInput.value = state.endpoint; diag.textContent=''; });
    $('#btnSave').addEventListener('click', ()=>{ state.endpoint = endpointInput.value.trim()||DEFAULT_ENDPOINT; if(!IS_LOCAL) state.endpoint=''; saveState(); });
    $('#btnTest').addEventListener('click', async()=>{ diag.textContent='Тествам…'; try{ const data=await api('/languages'); diag.textContent='OK: '+(Array.isArray(data)?data.map(x=>x.code).join(', '):JSON.stringify(data)); }catch(e){ diag.textContent='(Очаквано на Pages) '+e.message+' → използва се HTTPS fallback.'; }});

    // Top input buttons
    $('#userPaste').addEventListener('click', async()=>{ try{ $('#taUSER').value = await navigator.clipboard.readText(); }catch{} });
    $('#userCopy').addEventListener('click',  async()=>{ try{ await navigator.clipboard.writeText($('#taUSER').value||''); }catch{} });
    $('#userClear').addEventListener('click', ()=> $('#taUSER').value='');
    $('#userTranslate').addEventListener('click', ()=> translateFromUser());
    $('#taUSER').addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); translateFromUser(); }});

    // Panels
    $$('.card[data-lang]').forEach(card=>{
      const lang = card.dataset.lang; const ta = $('textarea', card);
      $('[data-action="make-active"]', card).addEventListener('click', ()=>{ state.activeLang=lang; saveState(); updatePairBadge(); });
      $('[data-action="translate"]', card).addEventListener('click', ()=> translateFromForeign(lang, ta.value));
      ta.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); translateFromForeign(lang, ta.value); }});
      $('[data-action="copy"]', card).addEventListener('click', async()=>{ try{ await navigator.clipboard.writeText(ta.value||''); }catch{} });
      $('[data-action="clear"]', card).addEventListener('click', ()=> ta.value='');
    });

    // Bottom quick swap
    $('#quickSwap').addEventListener('click', ()=>{ const order=['en','es','pt','de','tl','id']; const i=order.indexOf(state.activeLang); state.activeLang=order[(i+1)%order.length]; saveState(); updatePairBadge(); });

    // PWA install (optional)
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); window.deferredPrompt = e; $('#btnInstall').hidden = false; });
    $('#btnInstall').addEventListener('click', async()=>{ const p=window.deferredPrompt; if(!p) return; p.prompt(); await p.userChoice; $('#btnInstall').hidden = true; window.deferredPrompt=null; });
  }

  // ===== Boot =====
  loadState();
  applyI18N();
  updatePairBadge();
  wire();

  // Service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js', { scope: './' }).catch(()=>{});
  }
</script>
</body>
</html>
